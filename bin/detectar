#! /bin/bash 


ENOENTORNO=14

if [ ! $ENTORNO_INICIALIZADO ]; then
	echo "Detectar: Entorno no inicializado"
	exit $ENOENTORNO
fi

DETECTAR=$(basename $0)

# Funcion para imprimir por consola y al log
imprimir() {
	echo $1
	glog $DETECTAR $2 "$1"
}

# De todos los procesos actuales, selecciona los que se llaman detectar y cuenta
#+cuÃ¡ntos son.
CANTDETECTAR=$(ps -e | grep $DETECTAR | wc -l)
# Debe restarse uno porque el subshell abierto incrementa la cantidad de instancias informadas por ps
(( CANTDETECTAR -= 1 ))

# Forma alternativa (no siempre funciona bien, usa archivo temporal)
#ps -e | grep $DETECTAR | wc -l >temporal_secreto1234
#CANTDETECTAR2=$(cat temporal_secreto1234)
#rm temporal_secreto1234
#echo "CANTDETECTAR2=$CANTDETECTAR2"

# Chequea que no haya mas de una instancia de detectar corriendo (la actual).
if [ $CANTDETECTAR1 -gt 1 ]; then 
	imprimir "Detectar ya esta corriendo" W
	exit 0
fi

imprimir "Detectar iniciado" I

CICLOS=0
CANLOOP=3

while [ 1 ]
do
	(( CICLOS += 1 ))
	imprimir "Ciclo #$CICLOS"
	
	
	LISTA=$(ls -1 $DATADIR)
	ARCHIVOS=( $LISTA ) # Array que contiene cada linea de la lista como un elemento
	# Para cada elemento del directorio se realiza el procesamiento necesario
	for ARCHIVO in ${ARCHIVOS[*]}
	do
		# No se procesan directorios
		if [ -d $ARCHIVO ]; then continue; fi
		
		echo $ARCHIVO
	done
	
	# Se sale al alcanzar la cantidad maxima de ciclos de ejecucion
	if [ "$CICLOS" -ge "$CANLOOP" ]; then
		imprimir "Cantidad maxima de ciclos alcanzada" I
		exit 0
	fi
	
	sleep 1
done